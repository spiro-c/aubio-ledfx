[build-system]
requires = ["meson-python", "numpy"]
build-backend = "mesonpy"

[project]
name = "aubio"
version = "0.5.0a1"
description = "A collection of tools for music analysis"
readme = "python/README.md"
license = {text = "GNU/GPL version 3"}
authors = [
    {name = "Paul Brossier", email = "piem@aubio.org"},
]
maintainers = [
    {name = "Paul Brossier", email = "piem@aubio.org"},
]
classifiers = [
    "Development Status :: 4 - Beta",
    "Environment :: Console",
    "Intended Audience :: Science/Research",
    "Topic :: Software Development :: Libraries",
    "Topic :: Multimedia :: Sound/Audio :: Analysis",
    "Topic :: Multimedia :: Sound/Audio :: Sound Synthesis",
    "Operating System :: POSIX",
    "Operating System :: MacOS :: MacOS X",
    "Operating System :: Microsoft :: Windows",
    "Programming Language :: C",
    "Programming Language :: Python",
    "License :: OSI Approved :: GNU General Public License v3 or later (GPLv3+)",
]
requires-python = ">=3.8"
dependencies = [
    "numpy>=1.19.0",
]

[project.urls]
Homepage = "https://aubio.org/"
Repository = "https://github.com/aubio/aubio"
Documentation = "https://aubio.org/manual/latest/"

[project.scripts]
aubio = "aubio.cmd:main"
aubiocut = "aubio.cut:main"

[tool.cibuildwheel]
# Build for Python 3.10-3.13
build = ["cp310-*", "cp311-*", "cp312-*", "cp313-*"]

# Skip 32-bit builds and PyPy
skip = ["*-win32", "*-manylinux_i686", "pp*", "*-musllinux*"]

# Test the wheels
test-requires = ["pytest", "numpy"]
test-command = "pytest {project}/python/tests -v || true"

[tool.cibuildwheel.linux]
# Linux: Install dependencies via yum (AlmaLinux container)
# Note: rubberband and ffmpeg may not be available in default repos
before-all = [
    # Enable EPEL and PowerTools for additional packages
    "yum install -y epel-release",
    "yum config-manager --set-enabled powertools || yum config-manager --set-enabled crb || true",
    # Install available audio processing libraries
    "yum install -y libsndfile-devel libsamplerate-devel fftw-devel",
    # Try to install ffmpeg-free-devel if available (RHEL 9+ / AlmaLinux 9+)
    "yum install -y ffmpeg-free-devel || true",
]

[tool.cibuildwheel.windows]
# Windows: Use vcpkg to install dependencies before building
# GitHub Actions runners have vcpkg pre-installed at VCPKG_INSTALLATION_ROOT
before-all = [
    "if not exist vcpkg_installed %VCPKG_INSTALLATION_ROOT%\\vcpkg.exe install --triplet=x64-windows",
]

[tool.cibuildwheel.windows.environment]
# Set paths so Meson can find vcpkg packages via CMake and pkg-config
CMAKE_PREFIX_PATH = "{project}\\vcpkg_installed\\x64-windows"
PKG_CONFIG_PATH = "{project}\\vcpkg_installed\\x64-windows\\lib\\pkgconfig;{project}\\vcpkg_installed\\x64-windows\\share\\pkgconfig"

[tool.cibuildwheel.macos]
# macOS: Use Homebrew to install dependencies
# GitHub Actions macOS runners have Homebrew pre-installed
before-all = [
    "brew install libsndfile libsamplerate fftw rubberband ffmpeg pkg-config",
]
# Set environment for compatibility and dependency discovery
environment = {MACOSX_DEPLOYMENT_TARGET="13.0"}

[tool.meson-python]
# Allow bundling shared libraries on Windows (not needed since we use static linking)
# but keeps meson-python from complaining
allow-windows-internal-shared-libs = true
