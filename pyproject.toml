[build-system]
requires = ["meson-python", "numpy"]
build-backend = "mesonpy"

[project]
name = "aubio"
version = "0.5.0a1"
description = "A collection of tools for music analysis"
readme = "python/README.md"
license = {text = "GNU/GPL version 3"}
authors = [
    {name = "Paul Brossier", email = "piem@aubio.org"},
]
maintainers = [
    {name = "Paul Brossier", email = "piem@aubio.org"},
]
classifiers = [
    "Development Status :: 4 - Beta",
    "Environment :: Console",
    "Intended Audience :: Science/Research",
    "Topic :: Software Development :: Libraries",
    "Topic :: Multimedia :: Sound/Audio :: Analysis",
    "Topic :: Multimedia :: Sound/Audio :: Sound Synthesis",
    "Operating System :: POSIX",
    "Operating System :: MacOS :: MacOS X",
    "Operating System :: Microsoft :: Windows",
    "Programming Language :: C",
    "Programming Language :: Python",
    "License :: OSI Approved :: GNU General Public License v3 or later (GPLv3+)",
]
requires-python = ">=3.8"
dependencies = [
    "numpy>=1.19.0",
]

[project.urls]
Homepage = "https://aubio.org/"
Repository = "https://github.com/aubio/aubio"
Documentation = "https://aubio.org/manual/latest/"

[project.scripts]
aubio = "aubio.cmd:main"
aubiocut = "aubio.cut:main"

[tool.cibuildwheel]
# Build for Python 3.10-3.13
build = ["cp310-*", "cp311-*", "cp312-*", "cp313-*"]

# Skip 32-bit builds and PyPy
skip = ["*-win32", "*-manylinux_i686", "pp*", "*-musllinux*"]

# Test the wheels
test-requires = ["pytest", "numpy"]
test-command = "pytest {project}/python/tests || true"

[tool.cibuildwheel.linux]
# Linux: vcpkg dependencies are installed inside the manylinux container
# Use static libraries for true portability (no external .so dependencies)
before-all = [
    # Install build tools needed by vcpkg
    "yum install -y git zip unzip tar curl",
    # Clone and bootstrap vcpkg (not available in yum for manylinux)
    "git clone https://github.com/microsoft/vcpkg.git /tmp/vcpkg",
    "cd /tmp/vcpkg && ./bootstrap-vcpkg.sh -disableMetrics",
    # Install dependencies based on architecture
    # x64-linux and arm64-linux triplets provide static libraries by default
    # VCPKG_BUILD_TYPE=release skips Debug builds to speed up installation
    "cd {project}",
    "ARCH=$(uname -m)",
    "if [ \"$ARCH\" = \"x86_64\" ]; then VCPKG_BUILD_TYPE=release /tmp/vcpkg/vcpkg install --triplet=x64-linux; fi",
    "if [ \"$ARCH\" = \"aarch64\" ]; then VCPKG_BUILD_TYPE=release /tmp/vcpkg/vcpkg install --triplet=arm64-linux; fi",
]


[tool.cibuildwheel.linux.environment]
# Set paths so Meson can find vcpkg packages based on architecture
CMAKE_PREFIX_PATH = "{project}/vcpkg_installed/x64-linux:{project}/vcpkg_installed/arm64-linux"
PKG_CONFIG_PATH = "{project}/vcpkg_installed/x64-linux/lib/pkgconfig:{project}/vcpkg_installed/x64-linux/share/pkgconfig:{project}/vcpkg_installed/arm64-linux/lib/pkgconfig:{project}/vcpkg_installed/arm64-linux/share/pkgconfig"


[tool.cibuildwheel.windows]
# Windows: Use vcpkg to install dependencies before building
# GitHub Actions runners have vcpkg pre-installed at VCPKG_INSTALLATION_ROOT
# Note: rubberband doesn't support x64-windows-static, so we use x64-windows (dynamic)
# The DLLs will need to be bundled with the wheel
before-all = [
    "set VCPKG_BUILD_TYPE=release && if not exist vcpkg_installed %VCPKG_INSTALLATION_ROOT%\\vcpkg.exe install --triplet=x64-windows --vcpkg-root=%VCPKG_INSTALLATION_ROOT%",
]


[tool.cibuildwheel.windows.environment]
# Set paths so Meson can find vcpkg packages via CMake and pkg-config
CMAKE_PREFIX_PATH = "{project}\\vcpkg_installed\\x64-windows"
PKG_CONFIG_PATH = "{project}\\vcpkg_installed\\x64-windows\\lib\\pkgconfig;{project}\\vcpkg_installed\\x64-windows\\share\\pkgconfig"


[tool.cibuildwheel.macos]
# macOS: Use vcpkg to build dependencies from source targeting specific deployment targets
# This ensures compatibility with older macOS versions (Homebrew builds for current OS only)
# The MACOSX_DEPLOYMENT_TARGET is set in the workflow per-arch before vcpkg runs
# VCPKG_BUILD_TYPE=release skips Debug builds to speed up installation
before-all = [
    "if [ $(uname -m) = 'x86_64' ]; then VCPKG_BUILD_TYPE=release $VCPKG_INSTALLATION_ROOT/vcpkg install --triplet=x64-osx --vcpkg-root=$VCPKG_INSTALLATION_ROOT; fi",
    "if [ $(uname -m) = 'arm64' ]; then VCPKG_BUILD_TYPE=release $VCPKG_INSTALLATION_ROOT/vcpkg install --triplet=arm64-osx --vcpkg-root=$VCPKG_INSTALLATION_ROOT; fi",
]

[tool.cibuildwheel.macos.environment]
# Set paths so Meson can find vcpkg packages based on architecture
# A bit redundant since we have paths for each arch in the workflow but ensures both are available
CMAKE_PREFIX_PATH = "{project}/vcpkg_installed/x64-osx:{project}/vcpkg_installed/arm64-osx"
PKG_CONFIG_PATH = "{project}/vcpkg_installed/x64-osx/lib/pkgconfig:{project}/vcpkg_installed/x64-osx/share/pkgconfig:{project}/vcpkg_installed/arm64-osx/lib/pkgconfig:{project}/vcpkg_installed/arm64-osx/share/pkgconfig"


[tool.meson-python]
# Allow bundling shared libraries on Windows
# Required since we use dynamic linking (x64-windows) due to rubberband not supporting static
allow-windows-internal-shared-libs = true
